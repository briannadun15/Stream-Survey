<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Fish Survey</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useRef } = React;

    function FishSurveyApp() {
      const [count, setCount] = useState(0);
      const [isTracking, setIsTracking] = useState(false);
      const [surveyName, setSurveyName] = useState('');
      const [currentSession, setCurrentSession] = useState(null);
      const [sessions, setSessions] = useState([]);
      const [gpsAccuracy, setGpsAccuracy] = useState(null);
      const [lastLocation, setLastLocation] = useState(null);
      const [showInstructions, setShowInstructions] = useState(false);
      const [gpsError, setGpsError] = useState(null);
      const [gpsStatus, setGpsStatus] = useState('Not started');
      const [flicUrl, setFlicUrl] = useState('');
      const [showFlicSetup, setShowFlicSetup] = useState(false);
      const watchIdRef = useRef(null);
      const lastCheckRef = useRef(0);

      // Listen for Flic button presses via storage events
      useEffect(() => {
        const checkForFlicPress = () => {
          const flicPress = localStorage.getItem('flicPress');
          if (flicPress && isTracking) {
            const pressTime = parseInt(flicPress);
            if (pressTime > lastCheckRef.current) {
              lastCheckRef.current = pressTime;
              addFishCount();
            }
          }
        };

        // Check every 200ms for new presses
        const interval = setInterval(checkForFlicPress, 200);

        return () => clearInterval(interval);
      }, [isTracking, currentSession, lastLocation]);

      // Generate Flic URL based on current page
      useEffect(() => {
        const baseUrl = window.location.href.split('?')[0].split('#')[0];
        const triggerUrl = baseUrl.includes('index.html') 
          ? baseUrl.replace('index.html', 'flic-trigger.html')
          : baseUrl + (baseUrl.endsWith('/') ? '' : '/') + 'flic-trigger.html';
        setFlicUrl(triggerUrl);
      }, []);

      useEffect(() => {
        const saved = localStorage.getItem('fishSurveySessions');
        if (saved) {
          setSessions(JSON.parse(saved));
        }
      }, []);

      useEffect(() => {
        if (sessions.length > 0) {
          localStorage.setItem('fishSurveySessions', JSON.stringify(sessions));
        }
      }, [sessions]);

      useEffect(() => {
        const handleKeyPress = (e) => {
          if (isTracking && (e.code === 'Space' || e.code === 'ArrowRight' || e.code === 'ArrowLeft' || e.code === 'Enter')) {
            e.preventDefault();
            addFishCount();
          }
        };

        window.addEventListener('keydown', handleKeyPress);
        return () => window.removeEventListener('keydown', handleKeyPress);
      }, [isTracking, currentSession]);

      useEffect(() => {
        if (isTracking && 'geolocation' in navigator) {
          setGpsStatus('Requesting initial position...');
          setGpsError(null);
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setLastLocation({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: position.timestamp
              });
              setGpsAccuracy(position.coords.accuracy);
              setGpsStatus('GPS acquired!');
              setGpsError(null);
            },
            (error) => {
              console.error('Initial GPS error:', error);
              setGpsError(`Error: ${error.message} (Code: ${error.code})`);
              setGpsStatus('Failed to get initial position');
            },
            {
              enableHighAccuracy: true,
              maximumAge: 30000,
              timeout: 10000
            }
          );

          watchIdRef.current = navigator.geolocation.watchPosition(
            (position) => {
              setLastLocation({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: position.timestamp
              });
              setGpsAccuracy(position.coords.accuracy);
              setGpsStatus('GPS tracking active');
              setGpsError(null);
            },
            (error) => {
              console.error('GPS watch error:', error);
              setGpsError(`Watch error: ${error.message} (Code: ${error.code})`);
            },
            {
              enableHighAccuracy: true,
              maximumAge: 10000,
              timeout: 15000
            }
          );
        } else if (watchIdRef.current) {
          navigator.geolocation.clearWatch(watchIdRef.current);
          watchIdRef.current = null;
          setGpsStatus('Not tracking');
        } else if (isTracking && !('geolocation' in navigator)) {
          setGpsError('Geolocation not supported by browser');
          setGpsStatus('Not supported');
        }

        return () => {
          if (watchIdRef.current) {
            navigator.geolocation.clearWatch(watchIdRef.current);
          }
        };
      }, [isTracking]);

      const startSurvey = () => {
        if (!surveyName.trim()) {
          alert('Please enter a survey name');
          return;
        }

        const session = {
          id: Date.now(),
          name: surveyName,
          startTime: new Date().toISOString(),
          counts: []
        };

        setCurrentSession(session);
        setIsTracking(true);
        setCount(0);
        lastCheckRef.current = Date.now();
      };

      const addFishCount = () => {
        if (!currentSession || !lastLocation) return;

        const newCount = {
          number: count + 1,
          latitude: lastLocation.lat,
          longitude: lastLocation.lng,
          accuracy: lastLocation.accuracy,
          timestamp: new Date().toISOString()
        };

        setCurrentSession(prev => ({
          ...prev,
          counts: [...prev.counts, newCount]
        }));

        setCount(prev => prev + 1);
      };

      const endSurvey = () => {
        if (currentSession) {
          const completedSession = {
            ...currentSession,
            endTime: new Date().toISOString()
          };

          setSessions(prev => [...prev, completedSession]);
          setCurrentSession(null);
          setIsTracking(false);
          setCount(0);
          setSurveyName('');
          setGpsAccuracy(null);
        }
      };

      const exportToCSV = (session) => {
        const headers = ['Fish_Number', 'Latitude', 'Longitude', 'GPS_Accuracy_m', 'Timestamp', 'Survey_Name', 'Survey_Date'];
        const rows = session.counts.map(c => [
          c.number,
          c.latitude,
          c.longitude,
          c.accuracy.toFixed(1),
          c.timestamp,
          session.name,
          new Date(session.startTime).toLocaleDateString()
        ]);

        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.join(','))
        ].join('\n');

        downloadFile(csvContent, `${session.name}_${new Date(session.startTime).toISOString().split('T')[0]}.csv`, 'text/csv');
      };

      const exportToGeoJSON = (session) => {
        const features = session.counts.map(c => ({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [c.longitude, c.latitude]
          },
          properties: {
            fish_number: c.number,
            accuracy_m: c.accuracy,
            timestamp: c.timestamp,
            survey_name: session.name,
            survey_date: new Date(session.startTime).toLocaleDateString()
          }
        }));

        const geojson = {
          type: 'FeatureCollection',
          features: features
        };

        downloadFile(JSON.stringify(geojson, null, 2), `${session.name}_${new Date(session.startTime).toISOString().split('T')[0]}.geojson`, 'application/json');
      };

      const exportToShapefile = (session) => {
        const headers = ['WKT', 'Fish_Num', 'Survey', 'Date', 'Time', 'Accuracy'];
        const rows = session.counts.map(c => [
          `POINT(${c.longitude} ${c.latitude})`,
          c.number,
          session.name,
          new Date(c.timestamp).toLocaleDateString(),
          new Date(c.timestamp).toLocaleTimeString(),
          c.accuracy.toFixed(1)
        ]);

        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');

        downloadFile(csvContent, `${session.name}_${new Date(session.startTime).toISOString().split('T')[0]}_wkt.csv`, 'text/csv');
      };

      const downloadFile = (content, filename, mimeType) => {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      };

      const deleteSession = (sessionId) => {
        if (confirm('Delete this survey session?')) {
          setSessions(prev => prev.filter(s => s.id !== sessionId));
        }
      };

      const copyFlicUrl = () => {
        navigator.clipboard.writeText(flicUrl).then(() => {
          alert('URL copied! Paste this into your Flic button "Open Browser" action.');
        });
      };

      const getAccuracyColor = (accuracy) => {
        if (!accuracy) return 'text-gray-400';
        if (accuracy < 10) return 'text-green-500';
        if (accuracy < 30) return 'text-yellow-500';
        return 'text-red-500';
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-blue-900 mb-2 flex items-center gap-2">
                üìç Stream Fish Survey
              </h1>
              <p className="text-gray-600 mb-4">GPS-tracked fish counting with Flic button support</p>

              <button
                onClick={() => setShowFlicSetup(!showFlicSetup)}
                className="flex items-center gap-2 text-purple-600 hover:text-purple-800 mb-2 font-semibold"
              >
                üîµ {showFlicSetup ? 'Hide' : 'Show'} Flic Button Setup
              </button>

              {showFlicSetup && (
                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4 text-sm">
                  <h3 className="font-semibold mb-2">How to connect your Flic button:</h3>
                  <ol className="list-decimal list-inside space-y-2 text-gray-700">
                    <li>Open your Flic app</li>
                    <li>Select your Flic button</li>
                    <li>Add a new task: <strong>"Open Browser"</strong></li>
                    <li>Copy this URL and paste it into the Flic app:</li>
                  </ol>
                  <div className="bg-white border border-purple-300 rounded p-2 mt-2 mb-2 text-xs break-all font-mono">
                    {flicUrl}
                  </div>
                  <button
                    onClick={copyFlicUrl}
                    className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm font-semibold"
                  >
                    Copy URL
                  </button>
                  <p className="mt-3 text-gray-600"><strong>Note:</strong> After setup, keep this survey page open. Each Flic press will briefly open a new tab to register the count, then automatically close.</p>
                </div>
              )}

              <button
                onClick={() => setShowInstructions(!showInstructions)}
                className="flex items-center gap-2 text-blue-600 hover:text-blue-800 mb-4"
              >
                ‚ÑπÔ∏è <span className="text-sm">{showInstructions ? 'Hide' : 'Show'} Instructions</span>
              </button>

              {showInstructions && (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-sm">
                  <h3 className="font-semibold mb-2">How to use:</h3>
                  <ol className="list-decimal list-inside space-y-1 text-gray-700">
                    <li>Set up your Flic button using instructions above</li>
                    <li>Enter a survey name (e.g., "Miller Creek 2024")</li>
                    <li>Click "Start Survey" to begin tracking</li>
                    <li>Press your Flic button OR tap the count button on screen</li>
                    <li>Each count automatically saves GPS coordinates</li>
                    <li>End survey when complete</li>
                    <li>Export data as CSV (Excel), GeoJSON (QGIS/ArcGIS), or WKT format</li>
                  </ol>
                </div>
              )}

              {!isTracking ? (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Survey Name</label>
                    <input
                      type="text"
                      value={surveyName}
                      onChange={(e) => setSurveyName(e.target.value)}
                      placeholder="e.g., Miller Creek June 2024"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <button
                    onClick={startSurvey}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition"
                  >
                    ‚ñ∂Ô∏è Start Survey
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="bg-blue-900 text-white rounded-lg p-8 text-center">
                    <div className="text-6xl font-bold mb-2">{count}</div>
                    <div className="text-xl opacity-90">Fish Counted</div>
                  </div>

                  <div className="flex items-center justify-between text-sm bg-gray-50 p-3 rounded-lg">
                    <div className="flex items-center gap-2">
                      <span className={getAccuracyColor(gpsAccuracy)}>üìç</span>
                      <span className="text-gray-700">GPS Accuracy:</span>
                    </div>
                    <span className={`font-semibold ${getAccuracyColor(gpsAccuracy)}`}>
                      {gpsAccuracy ? `¬±${gpsAccuracy.toFixed(1)}m` : 'Acquiring...'}
                    </span>
                  </div>

                  {gpsError && (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-sm">
                      <p className="text-red-800 font-semibold">GPS Error:</p>
                      <p className="text-red-700">{gpsError}</p>
                      <p className="text-red-600 mt-2">Status: {gpsStatus}</p>
                    </div>
                  )}

                  {!gpsError && !lastLocation && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
                      <p className="text-yellow-800">Status: {gpsStatus}</p>
                      <p className="text-yellow-700 mt-1">Make sure location services are enabled and you're near a window or outside.</p>
                    </div>
                  )}

                  <div className="bg-purple-50 border border-purple-200 rounded-lg p-3 text-sm text-center">
                    <p className="text-purple-800 font-semibold">üîµ Flic button ready!</p>
                    <p className="text-purple-700">Press your Flic to count fish</p>
                  </div>

                  <button
                    onClick={addFishCount}
                    disabled={!lastLocation}
                    className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-6 px-6 rounded-lg text-xl transition"
                  >
                    Count Fish (or press Flic)
                  </button>

                  <button
                    onClick={endSurvey}
                    className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition"
                  >
                    ‚èπÔ∏è End Survey
                  </button>
                </div>
              )}
            </div>

            {sessions.length > 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Completed Surveys</h2>
                <div className="space-y-4">
                  {sessions.map(session => (
                    <div key={session.id} className="border border-gray-200 rounded-lg p-4">
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <h3 className="font-semibold text-lg text-gray-800">{session.name}</h3>
                          <p className="text-sm text-gray-600">
                            {new Date(session.startTime).toLocaleString()}
                          </p>
                          <p className="text-sm font-medium text-blue-600 mt-1">
                            {session.counts.length} fish counted
                          </p>
                        </div>
                        <button
                          onClick={() => deleteSession(session.id)}
                          className="text-red-500 hover:text-red-700"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <button
                          onClick={() => exportToCSV(session)}
                          className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded transition"
                        >
                          ‚¨áÔ∏è CSV
                        </button>
                        <button
                          onClick={() => exportToGeoJSON(session)}
                          className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded transition"
                        >
                          ‚¨áÔ∏è GeoJSON
                        </button>
                        <button
                          onClick={() => exportToShapefile(session)}
                          className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white text-sm py-2 px-3 rounded transition"
                        >
                          ‚¨áÔ∏è WKT CSV
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<FishSurveyApp />, document.getElementById('root'));
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>